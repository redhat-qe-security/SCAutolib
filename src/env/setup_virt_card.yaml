---
- name: Create required directories
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ nssdb }}"

- name: Initialize SoftHSM2 token
  shell: "softhsm2-util --init-token --slot 0 --label "SC test" --so-pin={{ sopin }} --pin={{ pin }}" 

- name: Create NSS database
  shell: "modutil -create -dbdir sql:{{ nssdb }} -force"

- name: Get p11-kit substring from NSS database
  shell: "modutil -list -dbdir sql:{{ nssdb }} | grep 'library name: p11-kit-proxy.so'"
  register: nssdb_p11_kit

- name: Check if p11-kit-proxy.so is present in NSS database
  shell: "modutil -force -add 'SoftHSM PKCS#11' -dbdir sql:{{ nssdb }} -libfile {{ p11lib }}"
  when: nssdb_p11_kit.rc != 0

- name: Add key to SoftHSM2 token in slot 0
  command:
    cmd: "pkcs11-tool --module libsofthsm2.so --slot-index 0 -w {{ username }}.key -y privkey --label {{ username }} -p {{ pin }} --set-id 0 -d 0"

- name: Add certificate to SoftHSM2 token in slot 0
  command:
    cmd: "pkcs11-tool --module libsofthsm2.so --slot-index 0 -w {{ username }}.crt -y cert --label {{ username }} -p {{ pin }} --set-id 0 -d 0"

